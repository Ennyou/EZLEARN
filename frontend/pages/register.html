<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="../imgs/favicon.ico" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <title>註冊</title>
  </head>

  <body>
    <div id="navbar"></div>

    <main
      class="flex justify-center relative"
      style="
        min-height: 80vh;
        background-image: url('../imgs/indexBg2.png'),
          url('../imgs/indexBg1.png');
        background-repeat: no-repeat, no-repeat;
        background-position: right, left;
        background-size: 500px, contain;
      "
    >
      <div class="flex justify-center items-center min-h-full">
        <div class="p-8 w-96 border">
          <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">
            註冊
          </h2>

          <hr class="border-gray-700 mb-4" />

          <form action="">
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="username"
              >
                姓名
              </label>
              <input
                class="appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight"
                name="username"
                id="username"
                type="text"
                placeholder="輸入姓名"
              />
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="email"
              >
                電子郵件
              </label>
              <input
                class="appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight"
                name="email"
                id="email"
                type="email"
                placeholder="輸入電子郵件"
              />
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="passwd"
              >
                密碼
              </label>
              <div class="relative">
                <input
                  class="appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight"
                  name="password"
                  id="password"
                  type="password"
                  placeholder="輸入密碼"
                />
                <i
                  id="switchpassword"
                  class="bi bi-eye-slash-fill absolute right-3 top-1/2 transform -translate-y-1/2"
                ></i>
              </div>
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="passwdagain"
              >
                確認密碼
              </label>
              <div class="relative">
                <input
                  class="appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight"
                  name="comfirmpassword"
                  id="comfirmpassword"
                  type="password"
                  placeholder="確認密碼"
                />
                <i
                  id="switchcomfirmpassword"
                  class="bi bi-eye-slash-fill absolute right-3 top-1/2 transform -translate-y-1/2"
                ></i>
              </div>
            </div>
            <div class="flex items-center">
              <div class="mb-4 w-2/3">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="birthday"
                >
                  生日
                </label>
                <input
                  class="appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight"
                  name="birthday"
                  id="birthday"
                  type="date"
                />
              </div>
              <div class="mb-4 ml-4 w-1/3">
                <label
                  class="block text-gray-700 text-sm font-bold mb-2"
                  for="gender"
                >
                  性別
                </label>
                <select
                  class="border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight"
                  name="gender"
                  id="gender"
                >
                  <option value="male">男性</option>
                  <option value="female">女性</option>
                </select>
              </div>
            </div>
            <div class="mb-6">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="phone"
              >
                電話
              </label>
              <input
                class="appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight"
                name="phone"
                id="phone"
                type="tel"
                placeholder="輸入電話"
              />
            </div>
            <div>
              <p id="error"></p>
            </div>
            <div class="flex items-center justify-center mb-4">
              <p id="error" class="text-red-600"></p>
              <p id="success"></p>
            </div>
            <div class="flex items-center justify-center mb-4">
              <button
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-full focus:outline-none focus:shadow-outline"
                type="button"
                id="btn"
              >
                註冊
              </button>
            </div>
            <div class="flex items-center justify-center mb-4">
              <a
                href="/pages/login.html"
                class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800"
                href="./login.html"
              >
                已經是會員了嗎?
              </a>
            </div>
          </form>
        </div>
      </div>
    </main>

    <div id="footer"></div>
    <script src="../js/header-footer.js"></script>
    <script>
      let nowdate = new Date();
      let year = nowdate.getFullYear();
      let month = nowdate.getMonth();
      let day = nowdate.getDate();
      month = month + 1 < 10 ? "0" + (month + 1) : month + 1;
      day = day < 10 ? "0" + day : day;
      $("#birthday").attr("max", year + "-" + month + "-" + day);

      let passwordeyeopen = 0;
      switchpassword.onclick = function () {
        if (passwordeyeopen == 0) {
          $("#password").attr("type", "text");
          $("#switchpassword").removeClass("bi-eye-slash-fill");
          $("#switchpassword").addClass("bi-eye-fill");
          passwordeyeopen = 1;
        } else {
          $("#password").attr("type", "password");
          $("#switchpassword").removeClass("bi-eye-fill");
          $("#switchpassword").addClass("bi-eye-slash-fill");
          passwordeyeopen = 0;
        }
      };

      let comfirmpasswordeyeopen = 0;
      switchcomfirmpassword.onclick = function () {
        if (comfirmpasswordeyeopen == 0) {
          $("#comfirmpassword").attr("type", "text");
          $("#switchcomfirmpassword").removeClass("bi-eye-slash-fill");
          $("#switchcomfirmpassword").addClass("bi-eye-fill");
          comfirmpasswordeyeopen = 1;
        } else {
          $("#comfirmpassword").attr("type", "password");
          $("#switchcomfirmpassword").removeClass("bi-eye-fill");
          $("#switchcomfirmpassword").addClass("bi-eye-slash-fill");
          comfirmpasswordeyeopen = 0;
        }
      };
      btn.onclick = function () {
        $("#error").text("");
        if ($("#username").val() == "") {
          $("#error").text("姓名為空!");
        } else if ($("#email").val() == "") {
          $("#error").text("信箱為空!");
        } else if (!validateEmail($("#email").val())) {
          $("#error").text("信箱格式錯誤!");
        } else if ($("#password").val() == "") {
          $("#error").text("密碼為空!");
        } else if ($("#password").val() != $("#comfirmpassword").val()) {
          $("#error").text("密碼與確認密碼不一致!");
        } else if ($("#birthday").val() == "") {
          $("#error").text("生日為空!");
        } else if ($("#phone").val() == "") {
          $("#error").text("電話為空!");
        } else if (!validatetel($("#phone").val())) {
          $("#error").text("電話格式錯誤!");
        } else {
          const data = {
            email: $("#email").val(),
            password: $("#password").val(),
            userInfo: {
              userName: $("#username").val(),
              birthday: $("#birthday").val(),
              gender: $("#gender").val(),
              phone: $("#phone").val(),
            },
          };
          fetch("http://10.0.104.199:8080/user/register", {
            method: "POST",
            headers: {
              "Content-Type": "application/json", // 設置請求內容類型為 JSON
            },
            body: JSON.stringify(data), // 將表單數據轉換為 JSON 字符串
          })
            .then((response) => response.text())
            .then((result) => {
              if (result == "true") {
                $("#success").text("註冊成功，等待兩秒後進入登入頁面");
                setTimeout(() => {
                  window.location.href = "./login.html";
                }, 2000);
              } else {
                $("#error").text("信箱已被註冊!");
              }
            });
        }
      };

      function validateEmail(email) {
        const re = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        return re.test(email);
      }
      function validatetel(tel) {
        const re = /^[0][0-9][0-9]{8}$/;
        return re.test(tel);
      }
      fetch("http://10.0.104.199:8080/user/islogin", {
        method: "get",
        credentials: "include",
      })
        .then((response) => response.text())
        .then((data) => {
          if (data == "true") {
            window.location.href = "../index.html";
          }
        });

      fetch("../components/navbar.html")
        .then((response) => response.text())
        .then((data) => {
          $("#navbar").html(data);
        });

      fetch("../components/footer.html")
        .then((response) => response.text())
        .then((data) => {
          $("#footer").html(data);
        });
    </script>
  </body>
</html>
